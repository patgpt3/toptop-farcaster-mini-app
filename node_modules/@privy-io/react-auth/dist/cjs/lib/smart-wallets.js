"use strict";var e=require("react"),r=require("viem"),n=require("../client/user.js"),t=require("../configuration/context.js"),i=require("../errors.js"),a=require("../hooks/internal-context.js"),s=require("../hooks/modal-context.js"),o=require("../hooks/privy-context.js"),c=require("../hooks/useSmartWalletChain.js"),l=require("../hooks/useWallets.js"),u=require("../screens/index.js"),d=require("../utils/index.js"),m=require("./getEmbeddedConnectedWallet.js"),p=require("./smart-wallets-shared.js");require("@ethersproject/address"),require("react/jsx-runtime"),require("../config.js"),require("../configuration/defaultClientConfig.js"),require("../constants.js"),require("../configuration/login-methods.js"),require("../configuration/wallets.js"),require("../connectors/chains/index.js"),require("../connectors/chains/arbitrum.js"),require("../connectors/chains/arbitrumSepolia.js"),require("../connectors/chains/avalanche.js"),require("../connectors/chains/avalancheFuji.js"),require("../connectors/chains/base.js"),require("../connectors/chains/baseSepolia.js"),require("../connectors/chains/berachainArtio.js"),require("../connectors/chains/celo.js"),require("../connectors/chains/celoAlfajores.js"),require("../connectors/chains/filecoin.js"),require("../connectors/chains/filecoinCalibration.js"),require("../connectors/chains/garnetHolesky.js"),require("../connectors/chains/holesky.js"),require("../connectors/chains/linea.js"),require("../connectors/chains/lineaTestnet.js"),require("../connectors/chains/lukso.js"),require("../connectors/chains/mainnet.js"),require("../connectors/chains/optimism.js"),require("../connectors/chains/optimismSepolia.js"),require("../connectors/chains/polygon.js"),require("../connectors/chains/polygonAmoy.js"),require("../connectors/chains/redstone.js"),require("../connectors/chains/sepolia.js"),require("../connectors/chains/zora.js"),require("../connectors/chains/zoraSepolia.js"),require("../connectors/chains/zoraTestnet.js"),require("../connectors/chains/utils.js"),require("./solana/index.js"),require("../theme.js"),require("tinycolor2"),require("./cybr53.js"),require("ofetch"),require("../hooks/index.js"),require("../components/PrefetchedImage.js"),require("@ethersproject/providers"),require("../connectors/get-legacy-injected-providers.js"),require("../connectors/is-wallet-installed.js"),require("permissionless"),require("permissionless/accounts"),require("permissionless/clients/pimlico"),require("viem/account-abstraction"),require("@privy-io/js-sdk-core");const h=({calls:e,chain:r,maxPriorityFeePerGas:n,maxFeePerGas:t,nonce:i})=>e.map((e=>({to:e.to||void 0,data:e.data,value:e.value,chainId:r.id,nonce:i,maxFeePerGas:t,maxPriorityFeePerGas:n}))),y=async({chain:e,paymasterContext:n,embeddedWallet:t,user:a,smartWalletsConfig:s,rpcConfig:o,privyAppId:c})=>{if(!s?.enabled||!a||!t)return;let l=await t.getEthereumProvider(),u=s?.configuredNetworks.find((r=>r.chainId===`eip155:${e.id}`));if(!u)throw new i.PrivyClientError(`The chain ${e.name} (eip155:${e.id}) must be configured in the smart wallet configuration in your dashboard`);let m=a.smartWallet?.smartWalletType??s.smartWalletType,h=d.getJsonRpcEndpointFromChain(e,o,c),y=r.createPublicClient({chain:e,transport:r.http(h)}),g=n??u.paymasterContext,q=await p.signerToSmartAccountClient({owner:l,smartWalletType:m,chain:e,publicClient:y,paymasterContext:g,...u});if(!q)throw new i.PrivyClientError(`Failed to create smart wallet client for chain ${e.name} (eip155:${e.id})`);return q};exports.callsToTransactionRequests=h,exports.getSmartWalletClient=y,exports.useSmartWalletsWrapper=({clientConfig:r,smartWalletsConfig:d})=>{let{noPromptOnSignature:p,openPrivyModal:g,appId:q}=a.usePrivyInternal(),f=t.useAppConfig(),{setModalData:j}=s.usePrivyModal(),{user:E}=o.usePrivyContext(),{chains:C}=t.useAppConfig(),{chainId:W,clients:I,setChainId:S,chainIdState:w}=c.useSmartWalletChains(),P=C.find((e=>e.id===w)),{wallets:v}=l.useWallets(),x=e.useCallback((async()=>W.current),[W]),T=e.useCallback((async({id:e})=>{if(!I.current[e]){let n=m.getEmbeddedConnectedWallet(v),t=await y({chain:C.find((r=>r.id===e)),embeddedWallet:n,user:E,paymasterContext:r?.paymasterContext,smartWalletsConfig:d,rpcConfig:f.rpcConfig,privyAppId:q});t&&(I.current[e]=t)}S(e)}),[C,r,v,E,d]);return{wrapSmartAccountClient:e=>{I.current[e.chain.id]=e,w||S(e.chain.id);return{...e,sendTransaction:async(e,r)=>{let t=void 0===f.embeddedWallets.showWalletUIs?f.embeddedWallets.noPromptOnSignature:!f.embeddedWallets.showWalletUIs,a=I.current[W.current];if(!a)throw new i.PrivyClientError(`Smart wallet client for chain (eip155:${W.current}) not found`);if(t)return p.current=!0,await a.sendTransaction(e).finally((()=>p.current=!1));let s=[];"calls"in e&&void 0!==e.calls?s=[...e.calls]:"to"in e&&(s=[{to:e.to,value:e.value||BigInt(0),data:e.data||"0x"}]);let o=async()=>{if(!a.paymaster)return!1;let{paymasterAndData:r,paymasterData:n}=await a.prepareUserOperation({calls:s,maxFeePerGas:e.maxFeePerGas,maxPriorityFeePerGas:e.maxPriorityFeePerGas,nonce:e.nonce?BigInt(e.nonce):void 0});return Number(r??n??0)>0};return new Promise((async(t,i)=>{p.current=!0;let{entropyId:c,entropyIdVerifier:l}=n.getEntropyDetailsFromUser(E);j({connectWallet:{entropyId:c,entropyIdVerifier:l,onCompleteNavigateTo:u.ModalScreen.EMBEDDED_WALLET_SEND_TRANSACTION_SCREEN,onFailure:()=>{}},sendTransaction:{transactionRequests:h({calls:s,chain:a.chain,maxPriorityFeePerGas:e.maxPriorityFeePerGas,maxFeePerGas:e.maxFeePerGas,nonce:e.nonce?BigInt(e.nonce):void 0}),entropyId:c,entropyIdVerifier:l,transactingWallet:{address:a.account.address,walletIndex:null},getIsSponsored:o,onConfirm:()=>a.sendTransaction(e),onSuccess:e=>t(e.hash),onFailure:i,uiOptions:r??{}}}),g(u.ModalScreen.EMBEDDED_WALLET_CONNECTING_SCREEN)})).finally((()=>{p.current=!1}))},signMessage:async(e,r)=>{let t=void 0===f.embeddedWallets.showWalletUIs?f.embeddedWallets.noPromptOnSignature:!f.embeddedWallets.showWalletUIs,a=I.current[W.current];if(!a)throw new i.PrivyClientError(`Smart wallet client for chain (eip155:${W.current}) not found`);return t?(p.current=!0,await a.signMessage({message:e.message}).finally((()=>p.current=!1))):new Promise((async(t,i)=>{let{entropyId:s,entropyIdVerifier:o}=n.getEntropyDetailsFromUser(E);p.current=!0,j({connectWallet:{entropyId:s,entropyIdVerifier:o,onCompleteNavigateTo:u.ModalScreen.EMBEDDED_WALLET_SIGN_REQUEST_SCREEN,onFailure:()=>{}},signMessage:{method:"personal_sign",data:e.message,confirmAndSign:()=>a.signMessage({message:e.message}),onSuccess:e=>t(e),onFailure:i,uiOptions:r??{}}}),g(u.ModalScreen.EMBEDDED_WALLET_CONNECTING_SCREEN)})).finally((()=>{p.current=!1}))},signTypedData:async(e,r)=>{let t=void 0===f.embeddedWallets.showWalletUIs?f.embeddedWallets.noPromptOnSignature:!f.embeddedWallets.showWalletUIs,a=I.current[W.current];if(!a)throw new i.PrivyClientError(`Smart wallet client for chain (eip155:${W.current}) not found`);return t?(p.current=!0,await a.signTypedData(e).finally((()=>p.current=!1))):new Promise((async(t,i)=>{p.current=!0;let{entropyId:s,entropyIdVerifier:o}=n.getEntropyDetailsFromUser(E);j({connectWallet:{entropyId:s,entropyIdVerifier:o,onCompleteNavigateTo:u.ModalScreen.EMBEDDED_WALLET_SIGN_REQUEST_SCREEN,onFailure:()=>{}},signMessage:{method:"eth_signTypedData_v4",data:e,confirmAndSign:()=>a.signTypedData(e),onSuccess:e=>t(e),onFailure:i,uiOptions:r??{}}}),g(u.ModalScreen.EMBEDDED_WALLET_CONNECTING_SCREEN)})).finally((()=>{p.current=!1}))},getChainId:x,chain:P,switchChain:T}}}};
