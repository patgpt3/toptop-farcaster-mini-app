"use strict";var e=require("./index.js"),t=require("../../utils/buffer/readBigInt64LE.js");let n=new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2});function r(e,t=6,n=!1,r=!1){let a=(parseFloat(e.toString())/1e9).toFixed(t).replace(/0+$/,"").replace(/\.$/,""),o=r?"":" SOL";return n?`${a}${o}`:`${"0"===a?"<0.001":a}${o}`}function a(e,t){let r=parseFloat(e.toString())/1e9,a=n.format(t*r);return"$0.00"===a?"<$0.01":a}function o(e){return"version"in e}async function s(e,t){return BigInt((o(e)?(await t.getFeeForMessage(e.message)).value:await e.getEstimatedFee(t))??0)}function i(e,n){try{return t.readBigInt64LEFromUint8Array(e,n)}catch{}try{return e.readBigInt64LE(n)}catch{}let r=Buffer.from(e);try{return t.readBigInt64LE(r)}catch{}try{return r.subarray(n).readBigInt64LE()}catch{}try{return r.readBigInt64LE(n)}catch{}return 0n}async function c(t,n,r,a,o){let[s,c,u]=t.accountKeyIndexes.map((e=>n.staticAccountKeys[e]));if(!s||!c||!u)throw Error("Invalid instruction");let l=await r.getParsedAccountInfo(c,"confirmed"),d=l.value?.data,f=d?.parsed?.info?.owner,m=d?.parsed?.info?.mint??"",p=o[m];if(!p){let t=await a.getSplTokenMetadata({mintAddress:m,cluster:e.getSolanaNetworkFromRpcEndpoint(r.rpcEndpoint)});t&&(p={address:m,symbol:t.symbol,decimals:t.decimals})}let y=p?.symbol??"",g=p?.decimals??d?.parsed?.info?.tokenAmount?.decimals??9,A=i(t.data,1);return{type:"spl-transfer",fromAta:s.toBase58(),fromAccount:u.toBase58(),toAta:c.toBase58(),toAccount:f,value:A,token:{symbol:y,decimals:g,address:m}}}async function u(e,t){let[n,r]=e.accountKeyIndexes.map((e=>t.staticAccountKeys[e]));if(!n||!r)throw Error("Invalid instruction");let a=i(e.data,4);return{type:"sol-transfer",fromAccount:n.toBase58(),toAccount:r.toBase58(),value:a,token:{symbol:"SOL",decimals:9}}}exports.LAMPORTS_PER_SOL=1e9,exports.SYSTEM_PROGRAM_ID="11111111111111111111111111111111",exports.TOKEN_2022_PROGRAM_ID="TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb",exports.TOKEN_PROGRAM_ID="TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA",exports.createSolanaTransactionReceipt=function(e,t){return{signature:e,parsedTransaction:t,fees:BigInt(t?.meta?.fee||0)}},exports.getDollarsFromLamport=a,exports.getNativeCurrencyFromLamports=r,exports.getSolanaFormattedAmounts=function({amount:e,fee:t,tokenPrice:n}){let o=BigInt(1e9*parseFloat(e)),s=o+t;return{fundingAmountInBaseUnit:o,fundingAmountInUsd:n?a(o,n):void 0,totalPriceInUsd:n?a(s,n):void 0,totalPriceInNativeCurrency:r(s),feePriceInNativeCurrency:r(t),feePriceInUsd:n?a(t,n):void 0}},exports.getTransactionFees=s,exports.getWalletPublicKeyFromTransaction=function(e,t){let n=(o(e)?e.message:e.compileMessage()).staticAccountKeys.find((e=>e.toBase58()===t));if(!n)throw Error(`Transaction does not contain public key ${t}`);return n},exports.hasSufficientFunds=async function(e,t){let{value:n}=await t.simulateTransaction(e);return null==n.err&&n.logs?.every((e=>!/insufficient funds/gi.test(e)))},exports.isVersionedTransaction=o,exports.parseSolanaTransaction=async function({tx:e,connection:t,client:n}){let r=o(e)?e.message:e.compileMessage(),a=r.staticAccountKeys[0]?.toBase58()??"",i=await s(e,t),l={},d=[];for(let e of r.compiledInstructions){let a=r.staticAccountKeys[e.programIdIndex]?.toBase58()||"";if("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"!==a&&"TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb"!==a)"11111111111111111111111111111111"!==a?d.push({type:"unknown",program:a}):d.push(await u(e,r));else{let a=await c(e,r,t,n,l);d.push(a),l[a.token.address]=a.token}}return{spender:a,fee:i,instructions:d}};
