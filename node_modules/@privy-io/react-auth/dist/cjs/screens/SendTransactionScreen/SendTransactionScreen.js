"use strict";var e=require("react/jsx-runtime"),r=require("react"),n=require("viem"),i=require("@privy-io/js-sdk-core"),o=require("../../configuration/context.js"),s=require("../../connectors/errors.js"),t=require("../../embedded-wallets/rpc/index.js"),a=require("../../hooks/internal-context.js"),c=require("../../hooks/modal-context.js"),u=require("../../hooks/privy-context.js"),l=require("../../hooks/useGetTokenPrice.js"),d=require("../../lib/erc20/actions/getErc20TokenInfo.js"),p=require("../../lib/erc20/formatErc20TokenAmount.js"),q=require("../../lib/ethers.js"),m=require("../../utils/index.js"),j=require("../ErrorScreen.js"),h=require("../index.js"),g=require("./SendTransactionScreenView.js"),T=require("./TransactionErrorView.js"),f=require("./TransactionReceiptView.js"),y=require("./getStaticTransactionMetadata.js"),b=require("./usePrepareTransaction.js");require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../constants.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../connectors/chains/utils.js"),require("../../lib/solana/index.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("@ethersproject/logger"),require("../../errors.js"),require("ofetch"),require("@ethersproject/providers"),require("../../hooks/index.js"),require("../../components/PrefetchedImage.js"),require("../../hooks/useGetSolPrice.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("@ethersproject/bignumber"),require("@ethersproject/units"),require("@heroicons/react/24/outline/ExclamationTriangleIcon"),require("@heroicons/react/24/outline/PhoneIcon"),require("styled-components"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/CircleBorder.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../components/layout/StackedContainer.js"),require("../../embedded-wallets/errors.js"),require("../../embedded-wallets/types.js"),require("../../hooks/captcha-context.js"),require("../../svg/lock-closed.js"),require("@heroicons/react/24/outline"),require("../../components/ModalFooter.js"),require("../../svg/protected-by-privy.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon"),require("../../components/ui/wallet/WalletInfoCard.js"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/layout/Column.js"),require("../../components/ui/typography/LabelXs.js"),require("../../components/ui/wallet/shared.js"),require("../LandingScreen/styles.js"),require("./TransactionDetail.js"),require("@ethersproject/address"),require("./useTransactionDetails.js"),require("@heroicons/react/24/outline/ClipboardDocumentCheckIcon"),require("@heroicons/react/24/outline/ClipboardDocumentIcon"),require("@heroicons/react/24/outline/ExclamationCircleIcon"),require("./EthersTransactionError.js"),require("../../components/Layouts.js"),require("../../components/ScreenHeader.js"),require("../../components/embedded-wallets/TransactionDetails.js"),require("../../components/embedded-wallets/DisplayInfoItem.js"),require("../../components/embedded-wallets/PriceDisplay.js"),require("../../lib/solana/transaction.js"),require("../../utils/buffer/readBigInt64LE.js"),require("../../components/embedded-wallets/TransactionTotal.js"),require("../../components/primitives/Accordion/index.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("../../components/primitives/Accordion/AccordionContext.js"),require("../../components/embedded-wallets/WalletLink.js"),require("../../lib/deployAccount/actions/abis/deployAccount.js"),require("../../lib/erc20/actions/abis/approve.js"),require("../../lib/erc20/actions/abis/transfer.js"),require("../../lib/erc721/actions/abis/mint.js"),require("../../lib/erc721/actions/abis/safeTransferFrom.js"),require("../../lib/erc721/actions/abis/setApprovalForAll.js"),require("../../lib/erc721/actions/abis/transferFrom.js"),require("../../lib/erc1155/actions/abis/safeBatchTransferFrom.js"),require("../../lib/erc1155/actions/abis/safeTransferFrom.js");let I=new s.PrivyProviderRpcError(new s.ProviderRpcError("There was an issue preparing your transaction",i.ProviderErrors.E32603_DEFAULT_INTERNAL_ERROR.eipCode)),E=(e,r)=>e?.sendTransaction?"transactionRequest"in e.sendTransaction?e.sendTransaction.transactionRequest:e.sendTransaction.transactionRequests[r]:void 0;exports.SendTransactionScreen=()=>{let v,{data:S,onUserCloseViaDialogOrKeybindRef:C,setModalData:w,navigate:k}=c.usePrivyModal(),{rpcConfig:x,chains:A,closePrivyModal:P,walletProxy:R}=a.usePrivyInternal(),{getAccessToken:F,user:D}=u.usePrivyContext(),N=o.useAppConfig(),[M,O]=r.useState(0),L=(K=S,K?.sendTransaction?"transactionRequest"in K.sendTransaction?0:K.sendTransaction.transactionRequests.length-1:0),[W,V]=r.useState(E(S,M)),[B,G]=r.useState(null),[_,H]=r.useState(),[U,Q]=r.useState(!1),[z,J]=r.useState(null),[X,$]=r.useState(null);var K;if(!W||!S?.sendTransaction||!S?.sendTransaction.transactingWallet)/*#__PURE__*/return e.jsx(j.ErrorScreenView,{error:Error("Invalid transaction request"),onClick:()=>{S?.sendTransaction?.onFailure(I),P({shouldCallAuthOnSuccess:!1})}});let{entropyId:Y,entropyIdVerifier:Z,transactingWallet:ee}=S.sendTransaction,re=r.useMemo((()=>A.find((e=>Number(e.id)===Number(W.chainId)))),[W.chainId]),ne=re?.nativeCurrency.symbol??"ETH",ie=r.useMemo((()=>y.getStaticTransactionMetadata(W.data,!!N.embeddedWallets.extendedCalldataDecoding)),[W.data]),{action:oe,isErc20Ish:se,isNFTIsh:te}=ie,{toAddress:ae,tokenAddress:ce}=r.useMemo((()=>({toAddress:ie.isErc20Ish?ie.transferTo:W.to,tokenAddress:ie.isErc20Ish?W.to:void 0})),[ie]);r.useEffect((()=>{W.to&&re&&se&&d.getErc20TokenInfo({address:W.to,chain:re,rpcConfig:N.rpcConfig,privyAppId:N.id}).then(G).catch(console.error)}),[W.to,re]);let{tokenPrice:ue,isTokenPriceLoading:le}=l.useGetTokenPrice(W.chainId),de=r.useMemo((()=>m.getJsonRpcProvider(Number(W.chainId),A,x,{appId:N.id})),[W.chainId,x]),pe=b.usePrepareTransaction(W,ee,de);r.useEffect((()=>{V(E(S,M))}),[M]),r.useEffect((()=>{S.sendTransaction?.getIsSponsored?S.sendTransaction.getIsSponsored().then(H).catch(console.error):H(!1)}),[S.sendTransaction.getIsSponsored]);let qe=()=>{if(!U)return z?S?.sendTransaction?.onSuccess(z.response):X||pe?.errors[0]?S?.sendTransaction?.onFailure(X??pe?.errors[0]??I):S?.sendTransaction?.onFailure(new s.PrivyProviderRpcError(new s.ProviderRpcError("The user rejected the request",i.ProviderErrors.E4001_USER_REJECTED_REQUEST.eipCode))),P({shouldCallAuthOnSuccess:!1})};C.current=qe;let me=!!(S.funding&&S.funding.supportedOptions.length>0),je="fiat-currency"===N.embeddedWallets.priceDisplay.primary,he=i.QuantityToBigNumber(pe?.tx.value??0).add(i.QuantityToBigNumber(pe?.totalGasEstimate?.toBigInt()??0)).toHexString(),ge=q.getNativeCurrencyFromWei(he,ne),Te=je&&ue?q.getDollarsFromWei(he,ue):void 0,fe=q.getNativeCurrencyFromWei(pe?.totalGasEstimate?.toString()??0,ne),ye=je&&ue?q.getDollarsFromWei(pe?.totalGasEstimate?.toString()??0,ue):void 0,be=q.getNativeCurrencyFromWei(pe?.balance?.toString()??0,ne,void 0,!0),Ie=je&&ue?q.getDollarsFromWei(pe?.balance?.toString()??0,ue):void 0,Ee=S.sendTransaction?.uiOptions?.transactionInfo?.title;Ee||(Ee="approve"===oe?se?"Confirm address":"Confirm action":`Approve ${oe}`);let ve=S.sendTransaction?.uiOptions?.description||`${N.name} wants your permission to approve the following transaction.`,Se=S.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/e.jsx("img",{src:S.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:S.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,Ce=!(!pe||pe.errors[0]||pe.hasFunds||!1!==_),we=Ce&&me,ke=we?"Add funds":S.sendTransaction?.uiOptions?.buttonText||(M<L?"Continue":"Approve");if(z?.receipt)/*#__PURE__*/return e.jsx(f.TransactionReceiptView,{txn:pe?.tx??W,onClose:qe,receipt:z.receipt,transactionInfo:S.sendTransaction?.uiOptions.transactionInfo,tokenPrice:ue,tokenSymbol:ne,l1GasEstimate:pe?.l1ExecutionFeeEstimate?.toString(),receiptHeader:S.sendTransaction?.uiOptions.successHeader,receiptDescription:S.sendTransaction?.uiOptions.successDescription});if(X)/*#__PURE__*/return e.jsx(T.TransactionErrorView,{transactionError:X,network:"ethereum",chainId:pe?.tx.chainId??W.chainId,onClose:qe,onRetry:({resetNonce:e})=>{$(null);let r={...pe?.tx??W};e&&(r.nonce=void 0),V(r)}});let xe=0!==L&&"number"==typeof M&&0!==M?()=>{O(M-1)}:void 0;return"amount"in ie&&ie.amount&&(ie.isNFTIsh?v=ie.amount.toString():B&&(v=p.formatErc20TokenAmount({amount:ie.amount,decimals:B.decimals}))),/*#__PURE__*/e.jsx(g.SendTransactionScreenView,{transactionIndex:M,onBack:xe,maxIndex:L,disabled:Ce&&!me,isSubmitting:U,submitError:X,isPreparing:!pe,isTokenPriceLoading:le,isTokenContractInfoLoading:!te&&!B,prepareError:pe?.errors[0],symbol:B?.symbol,chain:re,img:Se,title:Ee,subtitle:ve,total:W.value?Te??ge:void 0,txValue:W.value,fee:ye??fe,isSponsored:_,from:ee?.address??"",to:ae,tokenAddress:ce,network:N.chains.find((e=>e.id===W.chainId))?.name??"",transactionDetails:{...ie,formattedAmount:v},cta:ke,missingFunds:Ce,action:oe,balance:Ie??be,onClose:qe,onClick:we?async()=>{if(!ee)return;if(!me)throw Error("Funding wallet is not enabled");let e=h.ModalScreen.FUNDING_METHOD_SELECTION_SCREEN;w({...S,funding:{...S.funding,methodScreen:e,chainType:"ethereum",amount:n.formatEther(BigInt(pe?.tx.value??0)+BigInt(pe?.totalGasEstimate?.toString()??0)),chain:re}}),k(e)}:async()=>{if(M<L)O(M+1);else{Q(!0);try{let e=await F();if(U||!e||!ee||!R||!D)return;let r=S?.sendTransaction?.onConfirm?await S.sendTransaction.onConfirm().then((e=>de.getTransaction(e))):await t.sendTransaction({accessToken:e,transactingWallet:ee,entropyId:Y,entropyIdVerifier:Z,walletProxy:R,transactionRequest:pe?.tx??W,provider:de,requesterAppId:S.sendTransaction?.requesterAppId}),n=await r.wait();J({receipt:t.formatReceipt(n),response:r})}catch(e){console.warn({transaction:pe?.tx??W,error:e}),$(e)}finally{Q(!1)}}}})};
