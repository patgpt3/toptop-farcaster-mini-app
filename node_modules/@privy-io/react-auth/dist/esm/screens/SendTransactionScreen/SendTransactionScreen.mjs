import{jsx as o}from"react/jsx-runtime";import{useState as t,useMemo as n,useEffect as e}from"react";import{formatEther as r}from"viem";import{ProviderErrors as i,QuantityToBigNumber as s}from"@privy-io/js-sdk-core";import{useAppConfig as a}from"../../configuration/context.mjs";import{PrivyProviderRpcError as c,ProviderRpcError as m}from"../../connectors/errors.mjs";import{sendTransaction as p,formatReceipt as l}from"../../embedded-wallets/rpc/index.mjs";import{usePrivyInternal as d}from"../../hooks/internal-context.mjs";import{usePrivyModal as u}from"../../hooks/modal-context.mjs";import{usePrivyContext as h}from"../../hooks/privy-context.mjs";import{useGetTokenPrice as j}from"../../hooks/useGetTokenPrice.mjs";import{getErc20TokenInfo as f}from"../../lib/erc20/actions/getErc20TokenInfo.mjs";import{formatErc20TokenAmount as g}from"../../lib/erc20/formatErc20TokenAmount.mjs";import{getNativeCurrencyFromWei as T,getDollarsFromWei as b}from"../../lib/ethers.mjs";import{getJsonRpcProvider as I}from"../../utils/index.mjs";import{ErrorScreenView as y}from"../ErrorScreen.mjs";import{ModalScreen as E}from"../index.mjs";import{SendTransactionScreenView as C}from"./SendTransactionScreenView.mjs";import{TransactionErrorView as k}from"./TransactionErrorView.mjs";import{TransactionReceiptView as v}from"./TransactionReceiptView.mjs";import{getStaticTransactionMetadata as w}from"./getStaticTransactionMetadata.mjs";import{usePrepareTransaction as S}from"./usePrepareTransaction.mjs";import"../../config.mjs";import"../../configuration/defaultClientConfig.mjs";import"../../constants.mjs";import"../../configuration/login-methods.mjs";import"../../configuration/wallets.mjs";import"../../connectors/chains/index.mjs";import"../../connectors/chains/arbitrum.mjs";import"../../connectors/chains/arbitrumSepolia.mjs";import"../../connectors/chains/avalanche.mjs";import"../../connectors/chains/avalancheFuji.mjs";import"../../connectors/chains/base.mjs";import"../../connectors/chains/baseSepolia.mjs";import"../../connectors/chains/berachainArtio.mjs";import"../../connectors/chains/celo.mjs";import"../../connectors/chains/celoAlfajores.mjs";import"../../connectors/chains/filecoin.mjs";import"../../connectors/chains/filecoinCalibration.mjs";import"../../connectors/chains/garnetHolesky.mjs";import"../../connectors/chains/holesky.mjs";import"../../connectors/chains/linea.mjs";import"../../connectors/chains/lineaTestnet.mjs";import"../../connectors/chains/lukso.mjs";import"../../connectors/chains/mainnet.mjs";import"../../connectors/chains/optimism.mjs";import"../../connectors/chains/optimismSepolia.mjs";import"../../connectors/chains/polygon.mjs";import"../../connectors/chains/polygonAmoy.mjs";import"../../connectors/chains/redstone.mjs";import"../../connectors/chains/sepolia.mjs";import"../../connectors/chains/zora.mjs";import"../../connectors/chains/zoraSepolia.mjs";import"../../connectors/chains/zoraTestnet.mjs";import"../../connectors/chains/utils.mjs";import"../../lib/solana/index.mjs";import"../../theme.mjs";import"tinycolor2";import"../../lib/cybr53.mjs";import"@ethersproject/logger";import"../../errors.mjs";import"ofetch";import"@ethersproject/providers";import"../../hooks/index.mjs";import"../../components/PrefetchedImage.mjs";import"../../hooks/useGetSolPrice.mjs";import"../../connectors/get-legacy-injected-providers.mjs";import"../../connectors/is-wallet-installed.mjs";import"@ethersproject/bignumber";import"@ethersproject/units";import"@heroicons/react/24/outline/ExclamationTriangleIcon";import"@heroicons/react/24/outline/PhoneIcon";import"styled-components";import"../../components/Button.mjs";import"../../components/Loader.mjs";import"../../components/CircleBorder.mjs";import"../../components/ModalHeader.mjs";import"@heroicons/react/24/outline/ArrowLeftIcon";import"@heroicons/react/24/outline/ArrowRightIcon";import"@heroicons/react/24/outline/QuestionMarkCircleIcon";import"@heroicons/react/24/outline/XMarkIcon";import"../../components/layout/StackedContainer.mjs";import"../../embedded-wallets/errors.mjs";import"../../embedded-wallets/types.mjs";import"../../hooks/captcha-context.mjs";import"../../svg/lock-closed.mjs";import"@heroicons/react/24/outline";import"../../components/ModalFooter.mjs";import"../../svg/protected-by-privy.mjs";import"../../components/ui/layout/Row.mjs";import"../../components/ui/typography/ErrorMessage.mjs";import"../../components/ui/typography/LabelSm.mjs";import"../../components/ui/typography/Subtitle.mjs";import"../../components/ui/typography/Title.mjs";import"../../components/ui/typography/Value.mjs";import"../../components/ui/animation/LoadingSkeleton.mjs";import"../../components/ui/wallet/Address.mjs";import"@heroicons/react/24/outline/CheckIcon";import"@heroicons/react/24/outline/Square2StackIcon";import"../../components/ui/wallet/WalletInfoCard.mjs";import"../../components/ui/chips/Chip.mjs";import"../../components/ui/layout/Column.mjs";import"../../components/ui/typography/LabelXs.mjs";import"../../components/ui/wallet/shared.mjs";import"../LandingScreen/styles.mjs";import"./TransactionDetail.mjs";import"@ethersproject/address";import"./useTransactionDetails.mjs";import"@heroicons/react/24/outline/ClipboardDocumentCheckIcon";import"@heroicons/react/24/outline/ClipboardDocumentIcon";import"@heroicons/react/24/outline/ExclamationCircleIcon";import"./EthersTransactionError.mjs";import"../../components/Layouts.mjs";import"../../components/ScreenHeader.mjs";import"../../components/embedded-wallets/TransactionDetails.mjs";import"../../components/embedded-wallets/DisplayInfoItem.mjs";import"../../components/embedded-wallets/PriceDisplay.mjs";import"../../lib/solana/transaction.mjs";import"../../utils/buffer/readBigInt64LE.mjs";import"../../components/embedded-wallets/TransactionTotal.mjs";import"../../components/primitives/Accordion/index.mjs";import"@heroicons/react/24/outline/ChevronDownIcon";import"../../components/primitives/Accordion/AccordionContext.mjs";import"../../components/embedded-wallets/WalletLink.mjs";import"../../lib/deployAccount/actions/abis/deployAccount.mjs";import"../../lib/erc20/actions/abis/approve.mjs";import"../../lib/erc20/actions/abis/transfer.mjs";import"../../lib/erc721/actions/abis/mint.mjs";import"../../lib/erc721/actions/abis/safeTransferFrom.mjs";import"../../lib/erc721/actions/abis/setApprovalForAll.mjs";import"../../lib/erc721/actions/abis/transferFrom.mjs";import"../../lib/erc1155/actions/abis/safeBatchTransferFrom.mjs";import"../../lib/erc1155/actions/abis/safeTransferFrom.mjs";let x=new c(new m("There was an issue preparing your transaction",i.E32603_DEFAULT_INTERNAL_ERROR.eipCode)),A=(o,t)=>o?.sendTransaction?"transactionRequest"in o.sendTransaction?o.sendTransaction.transactionRequest:o.sendTransaction.transactionRequests[t]:void 0;const D=()=>{let D,{data:R,onUserCloseViaDialogOrKeybindRef:F,setModalData:O,navigate:L}=u(),{rpcConfig:P,chains:N,closePrivyModal:q,walletProxy:M}=d(),{getAccessToken:_,user:B}=h(),G=a(),[H,V]=t(0),U=(eo=R,eo?.sendTransaction?"transactionRequest"in eo.sendTransaction?0:eo.sendTransaction.transactionRequests.length-1:0),[W,z]=t(A(R,H)),[Q,X]=t(null),[$,J]=t(),[K,Y]=t(!1),[Z,oo]=t(null),[to,no]=t(null);var eo;if(!W||!R?.sendTransaction||!R?.sendTransaction.transactingWallet)/*#__PURE__*/return o(y,{error:Error("Invalid transaction request"),onClick:()=>{R?.sendTransaction?.onFailure(x),q({shouldCallAuthOnSuccess:!1})}});let{entropyId:ro,entropyIdVerifier:io,transactingWallet:so}=R.sendTransaction,ao=n((()=>N.find((o=>Number(o.id)===Number(W.chainId)))),[W.chainId]),co=ao?.nativeCurrency.symbol??"ETH",mo=n((()=>w(W.data,!!G.embeddedWallets.extendedCalldataDecoding)),[W.data]),{action:po,isErc20Ish:lo,isNFTIsh:uo}=mo,{toAddress:ho,tokenAddress:jo}=n((()=>({toAddress:mo.isErc20Ish?mo.transferTo:W.to,tokenAddress:mo.isErc20Ish?W.to:void 0})),[mo]);e((()=>{W.to&&ao&&lo&&f({address:W.to,chain:ao,rpcConfig:G.rpcConfig,privyAppId:G.id}).then(X).catch(console.error)}),[W.to,ao]);let{tokenPrice:fo,isTokenPriceLoading:go}=j(W.chainId),To=n((()=>I(Number(W.chainId),N,P,{appId:G.id})),[W.chainId,P]),bo=S(W,so,To);e((()=>{z(A(R,H))}),[H]),e((()=>{R.sendTransaction?.getIsSponsored?R.sendTransaction.getIsSponsored().then(J).catch(console.error):J(!1)}),[R.sendTransaction.getIsSponsored]);let Io=()=>{if(!K)return Z?R?.sendTransaction?.onSuccess(Z.response):to||bo?.errors[0]?R?.sendTransaction?.onFailure(to??bo?.errors[0]??x):R?.sendTransaction?.onFailure(new c(new m("The user rejected the request",i.E4001_USER_REJECTED_REQUEST.eipCode))),q({shouldCallAuthOnSuccess:!1})};F.current=Io;let yo=!!(R.funding&&R.funding.supportedOptions.length>0),Eo="fiat-currency"===G.embeddedWallets.priceDisplay.primary,Co=s(bo?.tx.value??0).add(s(bo?.totalGasEstimate?.toBigInt()??0)).toHexString(),ko=T(Co,co),vo=Eo&&fo?b(Co,fo):void 0,wo=T(bo?.totalGasEstimate?.toString()??0,co),So=Eo&&fo?b(bo?.totalGasEstimate?.toString()??0,fo):void 0,xo=T(bo?.balance?.toString()??0,co,void 0,!0),Ao=Eo&&fo?b(bo?.balance?.toString()??0,fo):void 0,Do=R.sendTransaction?.uiOptions?.transactionInfo?.title;Do||(Do="approve"===po?lo?"Confirm address":"Confirm action":`Approve ${po}`);let Ro=R.sendTransaction?.uiOptions?.description||`${G.name} wants your permission to approve the following transaction.`,Fo=R.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/o("img",{src:R.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:R.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,Oo=!(!bo||bo.errors[0]||bo.hasFunds||!1!==$),Lo=Oo&&yo,Po=Lo?"Add funds":R.sendTransaction?.uiOptions?.buttonText||(H<U?"Continue":"Approve");if(Z?.receipt)/*#__PURE__*/return o(v,{txn:bo?.tx??W,onClose:Io,receipt:Z.receipt,transactionInfo:R.sendTransaction?.uiOptions.transactionInfo,tokenPrice:fo,tokenSymbol:co,l1GasEstimate:bo?.l1ExecutionFeeEstimate?.toString(),receiptHeader:R.sendTransaction?.uiOptions.successHeader,receiptDescription:R.sendTransaction?.uiOptions.successDescription});if(to)/*#__PURE__*/return o(k,{transactionError:to,network:"ethereum",chainId:bo?.tx.chainId??W.chainId,onClose:Io,onRetry:({resetNonce:o})=>{no(null);let t={...bo?.tx??W};o&&(t.nonce=void 0),z(t)}});let No=0!==U&&"number"==typeof H&&0!==H?()=>{V(H-1)}:void 0;return"amount"in mo&&mo.amount&&(mo.isNFTIsh?D=mo.amount.toString():Q&&(D=g({amount:mo.amount,decimals:Q.decimals}))),/*#__PURE__*/o(C,{transactionIndex:H,onBack:No,maxIndex:U,disabled:Oo&&!yo,isSubmitting:K,submitError:to,isPreparing:!bo,isTokenPriceLoading:go,isTokenContractInfoLoading:!uo&&!Q,prepareError:bo?.errors[0],symbol:Q?.symbol,chain:ao,img:Fo,title:Do,subtitle:Ro,total:W.value?vo??ko:void 0,txValue:W.value,fee:So??wo,isSponsored:$,from:so?.address??"",to:ho,tokenAddress:jo,network:G.chains.find((o=>o.id===W.chainId))?.name??"",transactionDetails:{...mo,formattedAmount:D},cta:Po,missingFunds:Oo,action:po,balance:Ao??xo,onClose:Io,onClick:Lo?async()=>{if(!so)return;if(!yo)throw Error("Funding wallet is not enabled");let o=E.FUNDING_METHOD_SELECTION_SCREEN;O({...R,funding:{...R.funding,methodScreen:o,chainType:"ethereum",amount:r(BigInt(bo?.tx.value??0)+BigInt(bo?.totalGasEstimate?.toString()??0)),chain:ao}}),L(o)}:async()=>{if(H<U)V(H+1);else{Y(!0);try{let o=await _();if(K||!o||!so||!M||!B)return;let t=R?.sendTransaction?.onConfirm?await R.sendTransaction.onConfirm().then((o=>To.getTransaction(o))):await p({accessToken:o,transactingWallet:so,entropyId:ro,entropyIdVerifier:io,walletProxy:M,transactionRequest:bo?.tx??W,provider:To,requesterAppId:R.sendTransaction?.requesterAppId}),n=await t.wait();oo({receipt:l(n),response:t})}catch(o){console.warn({transaction:bo?.tx??W,error:o}),no(o)}finally{Y(!1)}}}})};export{D as SendTransactionScreen};
